
---
title: "New open-source model"
author: "Ron Handels"
date: "`r Sys.Date()`"
output:
  md_document:
    variant: markdown_github
    toc: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Quick guide

This GitHub repository provides the "IPECAD Open-Source Model v2 - Single-Domain" for cost-effectiveness analysis of Alzheimer's disease interventions. 

The model is a further development of a replicated model published by Wimo et al. [2020: https://www.doi.org/10.3233/JAD-191055]. 

The model is open-source available in 3 formats:   

Format      | Comment                                 | Link
:--         | :----                                   | :----
R           | using base R and `dampack` package      | https://github.com/ronhandels/ipecad/ > file `IPECAD open-source model.R`
spreadsheet | deterministic only                      | https://github.com/ronhandels/ipecad/ > file `IPECAD open-source model spreadsheet.ods`
Online      | deterministic only with selected inputs | https://ronhandels.shinyapps.io/ipecad/

This readme describes model installation, methods, development versions, and difference to "IPECAD Open-Source Model v1 - Multi-Domain". 


# Quick links

- ISPOR 2023 [presentation session](https://www.ispor.org/conferences-education/conferences/upcoming-conferences/ispor-europe-2023/program/program/session/euro2023-3781/17212) on IPECAD open-source model: 
- ISPOR 2023 [poster download](https://osf.io/7xbez) and [abstract](https://www.ispor.org/heor-resources/presentations-database/presentation/euro2023-3788/131246) on IPECAD workshop model cross-comparison


# Installation tutorial R version

* go to https://github.com/ronhandels/ipecad/ > click on '<> Code' (green button) > click on 'Download ZIP' > unzip all files
* install R
* install RStudio (optional but suggested)
* install `dampack` by running the code `install.packages("dampack")`
* open file 'IPECAD open-source model.R' in RStudio (or R)
* in the code under chapter 'TECHNICAL PREPARATION' change the working directory `~/GitHub/IPECAD` to the directory you have stored the file 'IPECAD open-source model.R' in to make sure the life table in the subfolder is correctly referred to. 
* we recommend familiarizing with the general description of the model provided below and the description of its input sources detailed below. 


# Cite this work

IPECAD open-source model https://github.com/ronhandels/IPECAD


# Background

Limited health-care resources require choices on how to distribute them. Cost-effectiveness analysis assesses the value an intervention to inform such choice. A decision-analytic model can be used when available empirical health-economic data are limited, for example to extrapolate beyond a randomized controlled trial follow-up period. Transparency and credibility of decision-models are key for their results to be used by decision-makers. 

Recent drug developments in Alzheimer’s disease (AD) have increased attention for decision-analytic models to assess their value. We aim to develop an open-source AD decision-model framework for the health-economic evaluation of AD interventions. We believe an open-source model supports transparency and credibility, and can be used to externally validate results generated by other decision-analytic models in AD. We welcome attributions to the model on github. 

Here we describe the methods and code of the open-source model for cost-effectiveness analysis of Alzheimer's disease interventions. 


# Method

A cohort state-transition Markov model has been developed. Initial development consisted of reconstructing an existing model in terms of its disease progression part (see https://www.doi.org/10.3233/JAD-191055). Then, inputs were changed and new features were added. See 'Version details' for more information.  


## Features and assumptions

The model has the following features and assumptions: 

* The model simulates 2 strategies: standard of care 'soc' and intervention 'int'; further referred to as a scenario (e.g., base case scenario). 
* The markov states include mild cognitive impairment 'mci', mild dementia 'mil', moderate dementia 'mod', severe dementia 'sev' and death 'dth'; with MCI and mild dementia split into on- and off-treatment. Dementia health states were defined by the Mini-Mental State Examination (MMSE) categorized into mild (30-21), moderate (20-10) and severe (0-9). 
* Transitions between health states other than death are simulated time-independent. 
* Non-death transition are conditional on being alive. Some non-sequential and backtransitions are allowed. On/off treatment conditions are independent of health state and unidirectional (only on to off). Transitions to institutionalization are unidirectional (only to institutionalization). Institutional setting does not contain treatment effects. 
* Mortality is implemented by multiplying an age- and sex-specific life table (user-defined) with the relative risk for death by disease severity state. 
* A cycle length of 1 year is employed with half-cycle correction operationalized as taking the mean of the health-economic outcomes at each 2 subsequent cycles. 
* The time horizon is variable, up to the age of 99. 
* The base population (user-defined) is defined by age (single age between 50-99) and sex (male or female), both used to select the corresponding age- and sex-specific mortality rate from a general population life table at each cycle. 
* Treatment effect is implemented as a relative risk with which forward transition rates (user-selected) were multiplied with. In the standard of care strategy all start off treatment, in the intervention strategy all start in on treatment. 
* Discounting (user-defined) is applied on the half-cycle corrected estimates. 
* The model runs for male or female separately. It is up to the end-user to provide weighted mean results. 

![Figure: Model structure (some back transitions are not shown)](https://github.com/ronhandels/IPECAD/blob/main/model_figure.png?raw=true)


## Input estimates of the base case scenario

The following input estimates were used for the base-case scenario: 

Parameter | Value    | Notes       | Source
:--       | :--      | :-----          | :--
v.names_state             | c("mcion", "mciof", "milon", "milof", "mod", "sev", "mci_i", "mil_i", "mod_i", "sev_i", "dth") | names of disease states: mci = mild cognitive impairment; mil = mild dementia; mod = moderate dementia; sev = severe dementia; dth = dead; x_i = institutionalized (without '_i' = community-living) | fixed 
v.names_strat             | c("soc","int") | strategies: soc = standard of care strategy; int = intervention strategy | fixed 
age_start                 | 70          | age of starting population | user-defined 
age_end                   | 99          | age up to which model is run (reflecting time horizon) | user-defined 
sex                       | "female"    | sex of starting population | user-defined 
p.mci_mil	                | 	0.206	    | 	transition probability MCI to mild dementia | 	[Wimo, 2020: https://doi.org/10.3233/jad-191055]	 
p.mci_mod	                | 	0	        | 	transition probability MCI to moderate dementia | 	idem	 
p.mci_sev	                | 	0	        | 	transition probability MCI to severe dementia | 	idem	 
p.mil_mci	                | 	0	        | 	transition probability mild dementia to MCI | 	idem	 
p.mil_mod	                | 	0.293	    | 	transition probability mild dementia to moderate dementia | 	idem	 
p.mil_sev	                | 	0.001	    | 	transition probability mild dementia to severe dementia | 	idem	 
p.mod_mil	                | 	0.087	    | 	transition probability moderate dementia to mild dementia | 	idem	 
p.mod_sev	                | 	0.109	    | 	transition probability moderate dementia to severe dementia | 	idem	 
p.sev_mil	                | 	0	        | 	transition probability severe dementia to mild dementia | 	idem	 
p.sev_mod	                | 	0.196	    | 	transition probability severe dementia to moderate dementia | 	idem	 
p.mci_i                   | 0           | transition probability MCI to institutionalized setting | [Neumann, 1999: https://doi.org/10.1212/wnl.57.6.957] 
p.mil_i                   | 0.038       | transition probability mild to institutionalized setting | idem 
p.mod_i                   | 0.110       | transition probability moderate to institutionalized setting | idem 
p.sev_i                   | 0.259       | transition probability severe to institutionalized setting | idem 
p.discontinuation1	      | 	0.1	      | 	transition probability from on to off treatment in year 1 (discontinuation) | 	user-defined	 
p.discontinuation_x	      | 	0.1	      | 	transition probability from on to off treatment after year 1 (discontinuation)  | 	user-defined	 
m.r.mortality	            | 	 m.mortality_rate_US 	 | 	general population mortality rate by age and sex (life table) | 	[https://www.cdc.gov/nchs/data/nvsr/nvsr70/nvsr70-19.pdf]	 
hr.mort_mci	              | 	1	        | 	hazard ratio mortality MCI assumed same as general population | 	assumption	 
hr.mort_verymilddem	      | 	1.82	    | 	hazard ratio mortality very mild dementia compared to no dementia | 	[Andersen, 2010: https://doi.org/10.1159/000265553]	 
hr.mort_mil	              | 	1.318	    | hazard ratio mortality mild dementia compared to very mild dementia | 	[Wimo, 2020: https://doi.org/10.3233/jad-191055] 
hr.mort_mod	              | 	2.419	    | 	hazard ratio mortality moderate dementia compared to very mild dementia | 	idem	 
hr.mort_sev	              | 	4.267	    | 	hazard ratio mortality severe dementia compared to very mild dementia | 	idem	 
rr.tx_mci_mil	            | 	0.75	    | 	relative risk treatment effect for transition MCI to mild dementia | 	user-defined	 
rr.tx_mci_mod	            | 	1	        | 	relative risk treatment effect for transition MCI to moderate dementia | 	user-defined	 
rr.tx_mci_sev	            | 	1	        | 	relative risk treatment effect for transition MCI to severe dementia | 	user-defined	 
rr.tx_mil_mod	            | 	0.75	    | 	relative risk treatment effect for transition mild dementia to moderate dementia | 	user-defined	 
tx_waning	                | 	0.05	    | 	annual treatment waning expressed as relative reduction in treatment effect | 	user-defined	 
tx_duration	              | 	7	        | 	maximum treatment duration | 	user-defined	 
p.starting_state_mci	    | 	1	        | 	proportion starting population in state MCI (1 minus this proportion starts in mild dementia); in the 'soc' strategy all start off-treatment, in 'int' strategy all start on-treatment | 	user-defined	 
u.mci                     |    0.73	    | 	utility MCI (mix community/institutional setting) | 	[Green, 2019: https://doi.org/10.1016/j.jalz.2019.05.004]	 
u.mil	                    | 	0.69	    | 	utility mild dementia (mix community/institutional setting) | 	idem	 
u.mod	                    | 	0.53	    | 	utility moderate dementia (mix community/institutional setting) | 	idem	 
u.sev	                    | 	0.38	    | 	utility severe dementia (mix community/institutional setting) | 	idem	 
c.mci	                    | 	 (1254 +  222) * 12 | 	costs MCI in community setting | 	[Tahami, 2023: https://doi.org/10.1007/s40120-023-00460-1]	 
c.mil	                    | 	 (1471 +  410) * 12 | 	costs mild dementia in community setting | 	idem	 
c.mod	                    | 	 (1958 +  653) * 12 | 	costs moderate dementia in community setting | 	idem	 
c.sev	                    | 	 (2250 + 1095) * 12 | 	costs severe dementia in community setting | 	idem	 
c.mci_i                   | (1254 + 8762) * 12 | 	costs MCI in institutional setting | idem	 
c.mil_i                   | (1471 + 8762) * 12 | 	costs mild dementia in institutional setting | idem  
c.mod_i                   | (1958 + 8762) * 12 | 	costs moderate dementia in institutional setting | idem  
c.sev_i                   | (2250 + 8762) * 12 | 	costs severe dementia in institutional setting | idem  
c.Tx	                    | 	10000	    | 	costs treatment | 	user-defined	 
c.Tx_diagnostics1	        | 	2000	    | 	costs diagnostics cycle 1 (not half-cycle corrected) | 	user-defined	 
discount_QALY	            | 	0.035	    | 	discount rate QALY | 	user-defined	 
discount_COST             | 	0.035	    | 	discount rate costs | 	user-defined	 
wtp                       |  40000	    | 	willingness to pay | 	user-defined	 

Notes on input estimates for the base case scenario: 

* p.mil_mod, p.mil_sev... etc: transition probabilities between dementia states were obtained from predicted values of an ordered probit model fitted to data from the Swedisch Dementia Registry (SveDem) longitudinal cognitive status after controlling for drop-out [Handels et al. 2020: https://doi.org/10.1002/alz.12050]. Cognitive status was reflected by the Mini-Mental State Examination (MMSE) and categorized as mild dementia (21-30), moderate dementia (10-20) or severe dementia (0-9) health state. 


## Alternative input estimates

Alternative input estimates from Vos et al. [2015: https://doi.org/10.1093/brain/awv029] are: 

* Amyloid positive & neuronal loss positive. Operationalized by diagnostic criteria NIA-AA categories: 'NIA-AA high AD' (Amyloid+, Injury+). Corresponding 3-year cumulative incidence probability: 'high AD' = 59% (AD dementia; table 3) and 4% (non-AD dementia; mentioned in text). This results into a weighted 3-year cumulative incidence of: `temp.est1 <- 1-exp(- (-log(1-0.59) + -log(1-0.04)) )` and corresponding 1-year probability of `1-exp(- -log(1-temp.est1)/3)` = 0.267. 
* Amyloid positive & neuronal loss undetermined. Operationalized by diagnostic criteria NIA-AA categories: 'NIA-AA high AD' (Amyloid+, Injury+) and 'conflicting IAP' (Amyloid+, Injury-). Corresponding 3-year cumulative incidence probability: 'high AD' = 59% (AD dementia; table 3) and 4% (non-AD dementia; mentioned in text), and 22% (AD dementia; table 3) and 4% (non-AD dementia; mentioned in text) with prevalence of 353 and 49 respectively (respectively). This results into a weighted 3-year cumulative incidence of (converting all 4 probabilities to rates before weighting and averaging): `temp.est2 <- 1-exp(- ( (-log(1-0.59) + -log(1-0.04))*353 + (-log(1-0.22) + -log(1-0.04))*49 ) / (353+49) )` and corresponding 1-year probability of `1-exp(- -log(1-temp.est2)/3)` = 0.248.


# Model code

## Basic overview of model code (R version)

The model code is build-up as follows: 

The model is run using 2 functions: run function `f.run_strategy` and run function `f.run_scenario`. 
The second function (`f.run_scenario`) includes a loop over all strategies by calling them one by one. 
Overall, the code follows these steps: 

* A: function to run a scenario
* B: prepare and initialize objects to store scenario and strategy outcomes
* C: run each strategy in a loop
* D: prepare inputs to be used in each strategy
* E: run preparations specific for the intervention strategy
* F: store newly created or updated inputs to be used for the function to run a single strategy
* G: run the strategy
  + G1: prepare transition probability matrix
  + G2: some checks
  + G3: initialize objects to store strategy outcomes
  + G4: starting state
  + G5: markov multiplication by looping over cycles
  + G6: multiply states with utility and cost estimates
  + G7: apply half-cycle correction
  + G8: apply discounting
  + G9: store outcomes to be wrapped up by the 'run scenario' function
* H: store strategy results
* I: add strategy results to scenario outcomes


## Coding reference

Standard naming for objects is 'x.object_name', with x: 

* v = vector
  * p = probability or proportion
  * r = rate
  * rr = relative risk or relative rate
  * hr = hazard ratio
  * n = number
  * u = utility
  * c = cost
* m = matrix
* a = array
* l = list 
* df = data frame
* f = function
* temp = temporary object

This is inspired by recommendations by https://github.com/DARTH-git/darthpack (https://rdcu.be/bRP5h or https://doi.org/10.1007/s40273-019-00837-x table 3). 


## Code comments

See code comments in file `IPECAD open-source model.R` to support readability and interpretation. 

<!-- ### transition probability matrix explained -->
<!-- [Will follow] -->


<!-- ... contains TPs between states, also over time -->
<!-- ... array is matrices stacked... refer to them by ... array[x,y,z] dimensions -->
<!-- ... video on time dependent TPs can be found here, and example code -->
<!-- .. explain a.TP... in our model -->


<!-- Within Markov processes, a TP matrix is used to describe the probabilities of transitioning from one state to another within a discrete-time Markov chain. Each element of the matrix represents the probability of moving from one state to another in one time step. This probability of transitioning to a future state only depends on the current state.  -->
<!-- The following table represents a simple TP matrix for the disease states relevant to dementia Alzheimer's disease states that were used in this model, the values within the TP matrix are randomized. The rows represent the current disease state, the columns represent the next possible disease states. The value in the matrix represents the TP within the given cycle length.  -->
<!-- |        | MCI   | Mild  | Moderate | Severe | Death | -->
<!-- | ------ | ----- | ----- | -------- | ------ | ----- | -->
<!-- | **MCI** | 0.5   | 0.4   | 0.1      | 0.0    | 0.0   | -->
<!-- | **Mild** | 0.0   | 0.6   | 0.3      | 0.1    | 0.0   | -->
<!-- | **Moderate** | 0.0   | 0.0   | 0.5      | 0.4    | 0.1   | -->
<!-- | **Severe** | 0.0   | 0.0   | 0.0      | 0.7    | 0.3   | -->
<!-- | **Death** | 0.0   | 0.0   | 0.0      | 0.0    | 1.0   | -->


<!-- 1. how the cycle-dependent TP matrix looks like (basically, explain how arrays work in a simple example and refer to details online R book).  -->

<!-- 2. explain how the 2 functions work with a simple example (so function `scenario` is used to prepare the inputs, then function `strategy` runs a strategy, then `scenario` takes the results and stores it (something along these lines). And refer to the available dampack R vignette and indicate we used that as an example.  -->

<!-- 3. explain the Markov principle and data dependencies:  -->

<!-- The model is build-up with the following dependencies: -->

<!-- * starting demographics (age and sex) and time are independent.  -->
<!-- * disease state 'dementia onset' is a function of time.  -->
<!-- * disease states within dementia are a function of the history if disease state (only 1 cycle back); indirectly they are a function of time.  -->
<!-- * death is a function of demographics and disease state.  -->
<!-- * QALYs & costs are a function of disease state and death.  -->


<!-- 5. Debugging basics: explain really quickly how the debuggint function in rstudio works (search for a video and web-page you can refer to). -->

<!-- 6. explain PSA (and refer to dampack) -->

<!-- 7. refer to a video on basic principles of markov matrix multiplication (part in the code with the %*%). Refer as much as possible to the video's on youtube "Markov modelling (theory only); Decision analytic modelling in health economics": https://youtube.com/playlist?list=PLIT7NqYN7YT3LNYOoTEFchRXX7crLfYa5  -->

<!-- 8. explain how a list works -->

<!-- 9. explain how treatment waning works: temp.waning <- (1-tx_waning)^(0:(n.cycle-1)) -->

<!-- 10. explain that '# probability of remaining in the same state' needed to be updated in the intervention strategy -->


# Version details

## main branch (planned to be released as v2.2.0-beta in late 2023)

This is for development and fine tuning before release, it is intended to be stable but not guaranteed. 

It extends v2.1.0 with new features (transitions to institutionalization, table/graph outcomes), new inputs (estimate of the transition from MCI to mild dementia, estimate for state-specific costs in community and institutional setting) and fixes (half-cycle correction before discounting). 

This version has been developed by: Ron Handels (main developer, Maastricht University - Netherlands) and Linh Nguyen. 


## newfeatures branch

This is for development, experimenting and exploring new features, it is not necessarily stable. 


## v2.1.0-beta (2023; released)

This version was build for the abstract submitted to ISPOR Europe 2023. 

This version has been developed and/or supported by:

* Ron Handels (main developer, Maastricht University - Netherlands)
* Anders Wimo
* Anders Sköldunger
* Ashley Tate
* Bengt Winblad
* Daphne Silvertand
* Linh Nguyen
* Linus Jönsson
* Sabine Grimm
* Sandar Aye
* Will Herring


## v2.0.1-alpha (2023)

We replaced any (non-rounded input) estimates or information not in the public domain with (rounded) input estimates or information available in the public domain. Specifically, this refers to the following aspects: 

* The original 'SveDem' model used a Swedish life table to apply mortality. The mortality rate was based on the weighted mean rate for men and women (weights based on the prevalence of age and sex in the Swedish population). For the model replication this was changed by using an updated Swedish life table and a sex-specific mortality rate. 
* The original 'SveDem' model multiplied the transition probability from MCI to mild dementia and from mild dementia to moderate dementia with the treatment effect expressed as a ratio. For the model replication this was changed by first transforming the transition probability to a rate, then multiplying it with the treatment effect expressed as a ratio, then transformed back to a transition probability. 
* The original 'SveDem' model used non-rounded input estimates for transition probabilities and mortality hazard ratios. For the model replication this was changed to only using estimates as publicly available in the publication (see supplemental material of earlier 'SveDem' model publication). 

This version is not publicly available given its the alpha version status. 

This version has been developed by: 

* Ron Handels
* Anders Wimo
* Linh Nguyen
* Daphne Silvertand


## v2.0.0-alpha (2023)

An existing model [Wimo et al. 2020: https://www.doi.org/10.3233/JAD-191055] (further referred to as 'original SveDem model') was reconstructed in terms of its disease progression part. This original SveDem model was a cohort-based Markov model and consisted of health states Mild Cognitive Impairment (MCI), mild dementia, moderate dementia, severe dementia and death. Progression between states was modeled with a cycle length of 1 year simulating from age 60 to 100. See publication for a detailed acknowledgment of the developers and funders (partly funded by Merck & Co., Inc., Kenilworth, NJ, USA). 

Reconstruction of the original SveDem model was done by the original developers Anders Wimo and Ron Handels using original non-rounded input estimates available in the original model format TreeAge and Excel. The reconstructed model produced the same model outcomes in terms of mean person-years per person per state and alive (table 1 and table 4 from earlier mentioned 'SveDem' model publication) when rounded to 2 decimal points, except for person-years in severe dementia after 40 years which had an absolute deviation of 0.01 person-years. Anders Wimo and Ron Handels considered this a sufficient reflection of internal validity. No specific funding was received for this reconstruction. 

This version is not publicly available given the dependency on non-publicly available information and its alpha version status. 

This version has been developed by: 

* Ron Handels
* Anders Wimo


## v1 (2019)

The IPECAD Open-Source Model v1 - Multi-Domain is an open-source model described in a publication [Green et al. 2019: https://doi.org/10.1016/j.jalz.2019.05.004] and can be freely requested at www.ipecad.org/open-source-model. This v1 is a different model independent from v2.


# Acknowledgment

We acknowledge all members of the IPECAD group [www.ipecad.org]. 

We acknowledge all (future) contributors to the model. 

We acknowledge the developers of the `dampack` [https://github.com/DARTH-git and http://darthworkgroup.com/]. 

